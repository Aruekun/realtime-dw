模拟神策埋点造数据。

# 数据模型简介

在神策分析中，我们使用事件模型（Event 模型）来描述用户在产品上的各种行为，这也是神策分析所有的接口和功能设计的核心依据。

在传统的 Web 时代，通常使用 PV（Page View 的简写，也即页面访问量）来衡量和分析一个产品的好坏，然后，到了移动互联网以及 O2O 电商时代，PV 已经远远不能满足产品和运营人员的分析需求了。

在这个年代，每个产品都有着独一无二的核心指标用来衡量产品是否成功，这个指标可能是发帖数量、视频播放数量、订单量或者其它的可以体现产品核心价值的指标，这些都是一个简单的 PV 无法衡量的。

除此之外，PV 模型也无法满足一些更加细节的、更加精细化的分析。例如，我们想分析哪类产品销量最好，访问网站的用户的年龄和性别构成，每个渠道过来的用户的转化率、留存和重复购买率分别如何，新老用户的客单价、流水、补贴比例分别是多少等等。这些问题，都是以 PV 为核心的传统统计分析没办法解答的问题。

因此，神策分析采用事件模型作为基本的数据模型。事件模型可以给我们更多的信息，让我们知道用户用我们的产品具体做了什么事情。事件模型给予我们更全面且更具体的视野，指导我们做出更好的决策。

## Event实体

简单来说，一个 Event 就是描述了：一个用户在某个时间点、某个地方，以某种方式完成了某个具体的事情。从这可以看出，一个完整的 Event，包含如下的几个关键因素：

- Who：即参与这个事件的用户是谁。在我们的数据接口中，使用 distinct_id 来设置用户的唯一 ID：对于未登录用户，这个 ID 可以是 cookie_id、设备 ID 等匿名 ID；对于登录用户，则建议使用后台分配的实际用户 ID。同时，我们也提供了 track_signup 这个接口，在用户注册的时候调用，用来将同一个用户注册之前的匿名 ID 和注册之后的实际 ID 贯通起来进行分析。

- When：即这个事件发生的实际时间。在我们的数据接口中，使用 time 字段来记录精确到毫秒的事件发生时间。如果调用者不主动设置，则各个 SDK 会自动获取当前时间作为 time 字段的取值。

-  Where：即事件发生的地点。使用者可以设置 properties 中的 $ip 属性，这样系统会自动根据 ip 来解析相应的省份和城市，当然，使用者也可以根据应用的 GPS 定位结果，或者其它方式来获取地理位置信息，然后手动设置 $city 和 $province。除了 $city 和 $province 这两个预置字段以外，也可以自己设置一些其它地域相关的字段。例如，某个从事社区 O2O 的产品，可能需要关心每个小区的情况，则可以添加自定义字段 “HousingEstate”；或者某个从事跨国业务的产品，需要关心不同国家的情况，则可以添加自定义字段 “Country”。

-  How：即用户从事这个事件的方式。这个概念就比较广了，包括用户使用的设备、使用的浏览器、使用的 App 版本、操作系统版本、进入的渠道、跳转过来时的 referer 等，目前，神策分析预置了如下字段用来描述这类信息，使用者也可以根据自己的需要来增加相应的自定义字段。

  ```undefined
  $app_version：应用版本
  $city： 城市
  $manufacturer： 设备制造商，字符串类型，如"Apple"
  $model： 设备型号，字符串类型，如"iphone6"
  $os： 操作系统，字符串类型，如"iOS"
  $os_version： 操作系统版本，字符串类型，如"8.1.1"
  $screen_height： 屏幕高度，数字类型，如1920
  $screen_width： 屏幕宽度，数字类型，如1080
  $wifi： 是否 WIFI，BOOL类型，如true
  ```

-  What：描述用户所做的这个事件的具体内容。在我们的数据接口中，首先是使用 event 这个事件名称，来对用户所做的内容做初步的分类。event 的划分和设计也有一定的指导原则，我们会在后文详细描述。除了 event 这个至关重要的字段以外，我们并没有设置太多预置字段，而是请使用者根据每个产品以及每个事件的实际情况和分析的需求，来进行具体的设置，下面给出一些典型的例子：
  \- 对于一个“购买”类型的事件，则可能需要记录的字段有：商品名称、商品类型、购买数量、购买金额、 付款方式等；
  \- 对于一个“搜索”类型的事件，则可能需要记录的字段有：搜索关键词、搜索类型等；
  \- 对于一个“点击”类型的事件，则可能需要记录的字段有：点击 URL、点击 title、点击位置等；
  \- 对于一个“用户注册”类型的事件，则可能需要记录的字段有：注册渠道、注册邀请码等；
  \- 对于一个“用户投诉”类型的事件，则可能需要记录的字段有：投诉内容、投诉对象、投诉渠道、投诉方式等；
  \- 对于一个“申请退货”类型的事件，则可能需要记录的字段有：退货金额、退货原因、退货方式等。



# 埋点数据

## 数据整体格式

### track

日志文件是一行一个 JSON，物理上对应一条数据，逻辑上对应一个描述了用户行为的事件，或是描述一个或多个用户属性的 Profile 操作。

记录一个 Event 及关联的 Properties。

数据样例：

```json
{
	"distinct_id": "123456",
	"time": 1434556935000,
	"type": "track",
	"event": "ViewProduct",
	"project": "ebiz_test",
	"time_free": true, //建议在导入历史数据时使用，SDK 采集的实时数据不建议使用
	"properties": {
		"$is_login_id":true, //此参数请慎重使用，详细介绍请参考文档底部 8.1 $is_login_id 参数说明
		"$app_version":"1.3",
		"$wifi":true,
		"$ip":"180.79.35.65",
		"$province":"湖南",
		"$city":"长沙",
		"$user_agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_2 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/58.0.3029.113 Mobile/14F89 Safari/602.1",
		"$screen_width":320,
		"$screen_height":568,
		"product_id":12345,
		"product_name":"苹果",
		"product_classify":"水果",
		"product_price":14.0
	}
}
```

对于上述字段的说明如下：

- distinct_id：***类型是字符串***，对用户的标识，对未登录用户，可以填充设备标识、CookieID 等，对于登录用户，则应该填充注册账号；这里的例子，我们假设是一个未注册用户，所以填充的是一个设备编号；
- time：***类型是数值***，事件发生的实际时间戳，精确到毫秒；
-  type：track 表明是记录一个 Event ，这里我们假设是一个商品浏览行为；
- event：事件名，需是合法的变量名，即不能以数字开头，且只包含：大小写字母、数字、下划线和 $，其中以 $ 开头的表明是系统的预置事件，自定义事件名请不要以 $ 开头，且 event 字段长度最大为 100；
-  project：这条数据所属项目名，若不指定该参数，则需要使用该字段时取值 ***default***，即默认项目。指定的项目必须是系统中已经存在的项目，否则这条数据将无效，更多项目相关请参见[多项目](https://manual.sensorsdata.cn/sa/latest/tech_knowledge_more-1573783.html)；
-  time_free：可选字段，表示不根据事件发生时间过滤该事件。***只要出现 time_free 这个 key 且 value 不为 null，将不再校验 time 是否在允许导入的时间范围内***。导入历史数据时可能会用到该字段；
- properties：这个 Event 的具体属性，以 dict 的形式存在。其中以 $ 开头的表明是系统的预置属性，它的类型和中文名已经预先定义好了。自定义属性名需要是合法的变量名，不能以数字开头，且只包含：大小写字母、数字、下划线，自定义属性不能以 $ 开头；同一个名称的 property，在不同 event 中，必须保持一致的定义和类型；同一个名称的 property 大小写不可以相同，如果已经存在小写属性就不可再导入对应大写属性（比如元数据中有 abc 属性名，不能再传 ABC,Abc 等属性名），否则数据会校验失败不入库。
  - $is_login_id：distinct_id 对应的是否是一个注册 ID；
  - $app_version：用户所使用的 App 的版本；
  - $wifi：这条事件发生时，用户是否在使用 wifi；
  - $ip：用户使用设备的 IP。若数据中出现 $ip，且数据中没有 $province 或 $city 字段，将使用该 IP 解析出省市信息填入缺失字段；
  - $province、$city：省、市，在没有填充这两个字段的时候，会根据 IP 进行解析；
  - $user_agent：可选参数。如果传入该参数，则解析 User-Agent，解析结果包括：设备制造商、设备型号、操作系统、操作系统版本、浏览器、浏览器版本、爬虫名称（如果是爬虫）；目前是神策是通过 UA 判断并有一个默认的属性 $bot_name （爬虫名称），但是有两种情况无法判断，第一种：如果 UA 里没有标明、且会触发 JS 脚本的非法爬虫。第二种：如果爬虫没有触发 JS 脚本，那么也不会触发我们的 SDK ，所以本身就不会被统计到。对于爬虫种类，不能提前把所有的种类都加进去，主流的神策都加了，其它的属于不太常见的，量较少。
  - $screen_width、$screen_height：屏幕的宽和高；
  - product_id、product_name、product_classify、product_price：跟商品相关的一些具体属性。



### 事件

- 事件名: AppStart

- 数据格式:

  ```json
  {
  	"distinct_id": "123456",
  	"time": 1434556935000,
  	"type": "track",
  	"event": "AppStart",
  	"properties": {
  		"$is_login_id":true, // distinct_id是否为登录id
      "device_id":"A45ED365-8F92-48A9-9F4B-48F50323974A", //设备id
      "user_id":"123456", //用户id，如果未登录则没有该字段
      "app_id":"1", //应用的唯一id
  		"app_version":"1.3", //app版本
      "carrier":"中国电信", //运营商:中国移动、中国联通、中国电信
      
  		"wifi":true, //是否是wifi
  		"ip":"180.79.35.65",
  		"province":"湖南",
  		"city":"长沙",
  		"user_agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_2 like Mac OS X) AppleWebKit/602.1.50 (KHTML, like Gecko) CriOS/58.0.3029.113 Mobile/14F89 Safari/602.1",
  		"screen_width":320,
  		"screen_height":568,
  		"product_id":12345,
  		"product_name":"苹果",
  		"product_classify":"水果",
  		"product_price":14.0
  	}
  }
  ```

  