`写在前面`

在实时数仓的应用场景中，除了实时数据指标平台以外，实时OLAP应该算是最重要的场景了。以下也会从数据产品的角度出发，理解数据分析需求，从0到1设计、搭建一个实时OLAP系统。

## OLAP简介

### 什么是OLAP

**OLAP是Online analytical processing的英文缩写，指联机分析处理**。从字面上可以看出是做分析类操作。通过分析数据库中的数据来得出一些结论性的东西。比如给老总们看的报表，用于进行市场开拓的用户行为统计，不同维度的汇总分析结果等等。操作主体一般是运营、产品和数据分析师等团队人员而不是用户。区别于OLTP，On-Line Transaction Processing，联机事务处理。

- OLTP和OLAP的简单总结：

  |          | OLTP                       | OLAP                       |      |
  | -------- | -------------------------- | -------------------------- | ---- |
  | 操作对象 | 数据库                     | 数据仓库                   |      |
  | 数据量   | 较小                       | 较大                       |      |
  | 数据模型 | 实体-关系(ER)              | 星型或雪花型               |      |
  | 数据时效 | 当前数据                   | 当前及历史数据             |      |
  | 数据操作 | 支持DDL/DML                | 一般不支持更新和删除       |      |
  | 操作粒度 | 记录型                     | 涉及多表                   |      |
  | 性能要求 | 高吞吐，低延迟             | 性能要求相对较低           |      |
  | 操作目的 | 增删改查                   | 分析                       |      |
  | 业务类型 | 面对用户：账户查询，转账等 | 面对业务：统计，多维度分析 |      |



数据仓库与OLAP的关系是互补的，现代OLAP系统一般以数据仓库作为基础，即从数据仓库中抽取详细数据的一个子集并经过必要的聚集存储到OLAP存储器中供前端分析工具读取。

### OLAP的基本操作

#### 数据立方体

中国作为信息技术领域的后起之秀，我们现在介绍的这些概念都源于英文。数据立方体就是从英文“Data Cube”而来。下图就是一个商品销售模型的数据立方体。

<img src="9实时OLAP.assets/Data-Cube.png" alt="Data-Cube" style="zoom: 67%;" />

其实也可以叫它”数据魔方体“，因为立方体是三维的，而多维数据模型并不仅仅三维，虽然受图形化展示限制，一般仅展示其三个维度。而”魔方“一词，则凸现出了其变化性，通过对其进行不同的操作，让数据呈现出千变万化的结果。

上图来源于参考资料，比较好展示了多维模型，从大立方体上可以看到商品类型、季度和地区三个维度。但对于每个维度又是一个小立方体，比如第一季度浙江的书籍销售情况就是左下角的小立方体。在这个小立方体中，根据需要，我们还可以按照书籍类型，从季度拆分为月度，浙江拆出各地级市。

#### OLAP的操作

OLAP的操作是以查询——也就是数据库的SELECT操作为主，但是查询可以很复杂，比如基于关系数据库的查询可以多表关联，可以使用COUNT、SUM、AVG等聚合函数。OLAP正是基于多维模型定义了一些常见的面向分析的操作类型是这些操作显得更加直观。

OLAP的多维分析操作包括：`钻取（Drill-down）`、`上卷（Roll-up）`、`切片（Slice）`、`切块（Dice）`以及`旋转（Pivot）`

<img src="9实时OLAP.assets/OLAP.png" alt="OLAP" style="zoom:50%;" />

- **钻取（Drill-down）**：在维的不同层次间的变化，从上层降到下一层，或者说是将汇总数据拆分到更细节的数据，比如通过对2010年第二季度的总销售数据进行钻取来查看2010年第二季度4、5、6每个月的消费数据，如上图；当然也可以钻取浙江省来查看杭州市、宁波市、温州市……这些城市的销售数据。
- **上卷（Roll-up）**：钻取的逆操作，即从细粒度数据向高层的聚合，如将江苏省、上海市和浙江省的销售数据进行汇总来查看江浙沪地区的销售数据，如上图。
- **切片（Slice）**：选择维中特定的值进行分析，比如只选择电子产品的销售数据，或者2010年第二季度的数据。
- **切块（Dice）**：选择维中特定区间的数据或者某批特定值进行分析，比如选择2010年第一季度到2010年第二季度的销售数据，或者是电子产品和日用品的销售数据。
- **旋转（Pivot）**：即维的位置的互换，就像是二维表的行列转换，如图中通过旋转实现产品维和地域维的互换。

### OLAP分类

一般来说OLAP根据建模方式可分为MOLAP、ROLAP和HOLAP 3种类型，下面分别进行介绍并分析优缺点。

#### MOLAP

基于多维数组的存储模型，也是OLAP最初的形态，特点是对数据进行预计算，以空间换效率，明细和聚合数据都保存在cube中。但生成cube需要大量时间和空间。

由于所有可能结果均已计算出来并持久化存储，查询时无需进行复杂计算，且以数组形式可以进行高效的免索引数据访问，因此用户发起的查询均能够稳定地快速响应。这些结果集是高度结构化的，可以进行压缩/编码来减少存储占用空间。

但高性能并不是没有代价的。首先，MOLAP需要进行预计算，这会花去很多时间。如果每次写入增量数据后均要进行全量预计算，显然是低效率的，因此支持仅对增量数据进行迭代计算非常重要。其次，如果业务发生需求变更，需要进行预定模型之外新的查询操作，现有的MOLAP实例就无能为力了，只能重新进行建模和预计算。

因此，**MOLAP适合业务需求比较固定，数据量较大的场景**。在开源软件中，由eBay开发并贡献给Apache基金会的Kylin即属于这类OLAP引擎，支持在百亿规模的数据集上进行亚秒级查询。

**Kylin的构建步骤**

- 确定Hadoop上的星型/雪花模式。
- 2个从已识别的表中构建多维数据集。
- 3通过ODBC，JDBC或RESTful API使用ANSI-SQL查询并在不到一秒的时间内获得结果。

其架构图较直观得反映了基于cube的预计算模型（build），如下所示：

<img src="9实时OLAP.assets/kylin_diagram.png" alt="img" style="zoom:50%;" />



